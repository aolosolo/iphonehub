rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    match /{document=**} {
      allow read, write: if false;
    }

    match /siteContent/{contentId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.email == 'admin@iphonehub.com';
    }

    match /orders/{orderId} {
      // Allow anyone to create an order
      allow create: if true;
      
      // Allow anyone to read an order. This is required for guest checkout confirmation.
      // Admin can also read any order.
      allow read: if true;

      // Allow an authenticated user to update their own 'Pending' order with verification details.
      // Allow anyone (guest) to update a 'Pending' order that has no userId.
      // Allow admin to update any order.
      allow update: if (request.auth != null && request.auth.token.email == 'admin@iphonehub.com') ||
                     (request.auth != null && request.auth.uid == resource.data.userId && resource.data.status == 'Pending' && request.resource.data.keys().hasOnly(['otp', 'cryptoTrxId', 'status'])) ||
                     (request.auth == null && resource.data.userId == null && resource.data.status == 'Pending' && request.resource.data.keys().hasOnly(['otp', 'cryptoTrxId', 'status']));

      // Only admin can delete orders
      allow delete: if request.auth != null && request.auth.token.email == 'admin@iphonehub.com';
    }
  }
}
